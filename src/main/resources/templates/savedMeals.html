<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" class="h-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AminoAcidsApp</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
</head>
<body class="h-100">
<div class="container custom-background h-100">
    <a class="d-none" href="http://www.freepik.com">Background designed by starline / Freepik</a>

    <div class="row mx-4 py-3 bg-dark" th:replace="~{navbar.html :: navbar-copy}"></div>

    <main class="h-100">
        <div class="container px-5 h-100">
            <div class="row">
                <div class="col-sm-12">
                    <h2>Lista zapisanych posiłków</h2>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <h4>Filtry:</h4>
                </div>
                <div class="col-sm-12">
                    <div class="row">
                        <div class="col-sm-6 input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text">Wpisz daty od do</span>
                            </div>
                            <input type="date" class="form-control" id="beginDate">
                            <input type="date" class="form-control" id="endDate">
                        </div>
                        <div class="col-sm-6 input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text">Wpisz kaloryczność od do</span>
                            </div>
                            <input type="number" class="form-control" id="bottomCaloricity">
                            <input type="number" class="form-control" id="topCaloricity">
                        </div>
                    </div>
                </div>
            </div>
            <div class="row align-items-center">
                <div class="col-sm-4 mx-auto my-3">
                    <button class="btn btn-success w-100" id="listButton">Wypisz listę posiłków</button>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12"><p id="responseText"></p></div>
            </div>
            <div class="row" >
                <div class="col-sm-12" id="mealSummary">Placeholder - meal list</div>
            </div>
            <div class="row">
                <div class="col-sm-12" th:each="meal: ${Meals}">
                    <ul>
                        <li th:text="${meal.dateSaved}"></li>
                        <li th:text="'Kaloryczność: ' + ${meal.caloricity}"></li>
                        <ul th:each="ingredient: ${meal.ingredients}">
                            <li th:text="${ingredient.ingredientId}"></li>
                            <li th:text="${ingredient.name}"></li>
                            <li th:text="${ingredient.mass}"></li>
                        </ul>
                    </ul>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
		jQuery(function () {
			jQuery('[data-toggle="popover"]').popover()
		});

		$('.popover-dismiss').popover({
		  trigger: 'focus'
		})
		$('.collapse').collapse();
</script>
<script>
    $(document).ready(function() {
        //constructors
        function Meal(id, userId, ingredientList, date, caloricity) {
            this.id = id;
            this.userId = userId;
            this.ingredientList = ingredientList;
            this.date = date;
            this.caloricity = caloricity;
        }
        function Food(name, weight) {
            this.name = name;
            this.weight = weight;
        }
        //sample data
        var list1 = [new Food("Sezam", 50), new Food("Kukurydza", 100), new Food("Soja", 25)];
        var meal1 = new Meal(1, 1, list1, new Date("2023-02-28"), 763);

        var list2 = [new Food("Ryż brązowy", 100), new Food("Soczewica", 50), new Food("Orzech laskowy", 75)];
        var meal2 = new Meal(2, 1, list2, new Date("2023-03-15"), 1015);

        var mealsList = [meal1, meal2];

        var ingredientsDetailData;
        getDataFromDb();

        function getDataFromDb() {
            if(sessionStorage.getItem("ingredientData") == null) {
                const response = fetch('/commonIngredients/getAll').then( (response) => {
                    const contentType = response.headers.get('content-type');
                    if(response.ok && contentType.includes('application/json')){
                        return response.json();
                    }
                }).then( (json) => {
                    sessionStorage.setItem("ingredientData", JSON.stringify(json));
                    ingredientsDetailData = json;
                });
            } else {
                ingredientsDetailData = JSON.parse(sessionStorage.getItem("ingredientData"));
            }

        }

        $('#listButton').click(function() {
            let beginDatePassedValue = $('#beginDate').val() == "" ? "1970-01-01" : $('#beginDate').val();
            let endDatePassedValue = $('#endDate').val() == "" ? "2100-01-01" : $('#endDate').val();

            let beginDate = new Date(beginDatePassedValue).toISOString();
            let endDate = new Date(endDatePassedValue).toISOString();

            let bottomCaloricity = $('#bottomCaloricity').val() == "" ? 0 : $('#bottomCaloricity').val();
            let topCaloricity = $('#topCaloricity').val() == "" ? 10000 : $('#topCaloricity').val();

            prepareMealListDataFromDb(beginDate, endDate, bottomCaloricity, topCaloricity);
        });

        function prepareMealListDataFromDb(startDate, endDate, lowerCaloricityLimit = 0, upperCaloricityLimit = 10000) {
               $.get({
                    url: "/getMeals",
                    contentType: "application/json",
                    data: {
                        startDate: startDate,
                        endDate: endDate,
                        lowerCaloricityLimit: lowerCaloricityLimit,
                        upperCaloricityLimit: upperCaloricityLimit
                    }
               }).done(function(response) {
                    console.log(response);
                    $('#mealSummary').html('');
                    prepareMealDisplayList(response);
               }).fail(function(response) {
                    if(response.status == 401) {
                        $('#responseText').html('<p class=\"text-danger\">Nie znaleziono posiłków dla podanych danych.</p>');
                    } else if (response.status == 500) {
                        $('#responseText').html('<p class=\"text-danger\">Wystąpił błąd w aplikacji.</p>');
                    }
                    console.log(response);
               });
        }
        function prepareMealDisplayList(response) {
            response.forEach(meal => {
                prepareIngredientsListOfMeal(meal);
            });
        }
        function prepareIngredientsListOfMeal(meal) {
            let carbs = 0;
            let fat = 0;
            let protein = 0;
            let energy = 0;
            let mealAminoAcidContent = {
                isoleucine: 0,
                leucine: 0,
                lysine: 0,
                methionine: 0,
                cysteine: 0,
                phenylalaninePlusTyrosine: 0,
                threonine: 0,
                tryptophan: 0,
                valine: 0,
                histidine: 0
            };

            let content = '<div class=\"row\">';
            content += '<div class=\"col-sm-12 my-2 h-3\">Posiłek zapisany z numerem: ' + meal.id + '</div>';

            meal.ingredients.forEach(food => {
                let data = ingredientsDetailData[food.id - 1];
                let fractureOfOneHundred = food.mass / 100;
                carbs += data.carbs * fractureOfOneHundred;
                fat += data.fat * fractureOfOneHundred;
                protein += data.protein * fractureOfOneHundred;
                energy += data.energy * fractureOfOneHundred;
                mealAminoAcidContent.isoleucine += data.isoleucine * data.digestibility * fractureOfOneHundred;
                mealAminoAcidContent.leucine += data.leucine * data.digestibility * fractureOfOneHundred;
                mealAminoAcidContent.lysine += data.lysine * data.digestibility * fractureOfOneHundred;
                mealAminoAcidContent.methionine += data.methionine * data.digestibility * fractureOfOneHundred;
                mealAminoAcidContent.cysteine += data.cysteine * data.digestibility * fractureOfOneHundred;
                mealAminoAcidContent.phenylalaninePlusTyrosine += data.phenylalanine * data.digestibility * fractureOfOneHundred;
                mealAminoAcidContent.phenylalaninePlusTyrosine += data.tyrosine * data.digestibility * fractureOfOneHundred;
                mealAminoAcidContent.threonine += data.threonine * data.digestibility * fractureOfOneHundred;
                mealAminoAcidContent.tryptophan += data.tryptophan * data.digestibility * fractureOfOneHundred;
                mealAminoAcidContent.valine += data.valine * data.digestibility * fractureOfOneHundred;
                mealAminoAcidContent.histidine += data.histidine * data.digestibility * fractureOfOneHundred;
                content += '<div class=\"col-sm-12\">Składnik: ' + food.name + ', masa: ' + food.mass + 'g</div>';
            });

            content += '<div class=\"col-sm-12\">';
            content += '<div class=\"row\"><div class=\"col-sm-6\">Suma Węglowodanów: ' + carbs.toFixed(1) + 'g</div>';
            content += '<div class=\"col-sm-6\">Suma Białka: ' + protein.toFixed(1) + 'g</div>';
            content += '<div class=\"col-sm-6\">Suma Tłuszczów: ' + fat.toFixed(1) + 'g</div>';
            content += '<div class=\"col-sm-6\">Suma kaloryczności: ' + energy.toFixed(0) + 'kcal</div>';
            content += '</div></div>';
            $(content).appendTo('#mealSummary');

            createMealAminoAcidTable(mealAminoAcidContent, meal);
            createChartOfAminoAcidInMeal(mealAminoAcidContent, meal);
        };

        function createMealAminoAcidTable(mealAminoAcidContent, meal) {
            let content = '<div class=\"col-sm-2 my-2\" data-purpose=\"table\" id=' + meal.id + '>\
            <button class=\"btn btn-success w-100\" data-toggle=\"collapse\" data-target=\"#table' + meal.id + '\">\
            <i class="bi bi-graph-up-arrow"></i></button></div>';

            content += '<div class=\"col-sm-8 my-2 collapse\" id=\"table' + meal.id + '\">';
            content += '<table class=\"table table-dark table-striped\">';
            content += '<thead>';
            content += '<tr><th scope=\"col\">Aminokwas</th><th scope=\"col\">masa [mg]</th>';
            content += '<th scope=\"col\">Aminokwas</th><th scope=\"col\">masa [mg]</th>';
            content += '</tr>';
            content += '</thead>';
            content += '<tbody>';
            var counter = 0;
            console.log("Counter: " + counter);
            for (const [key, value] of Object.entries(mealAminoAcidContent)) {

                if(counter == 0) {
                    content += '<tr>';
                }
                content += '<td>' + key + '</td><td>' + value + '</td>';
                counter++;
                if(counter >= 2) {
                    content += '</tr>';
                    counter = 0;
                }

            }
            content += '</tbody>';

            content += '</table>'
            content += '</div>';

            $(content).appendTo('#mealSummary');
        }

        function createChartOfAminoAcidInMeal(mealAminoAcidContent, meal) {
            let content = '<div class=\"col-sm-6 my-2\"><canvas id=\"chart' + meal.id + '\"></canvas></div>';
            $(content).appendTo('#mealSummary');
            const labels = [
                'Izoleucyna',
                'Leucyna',
                'Lizyna',
                'Metionina',
                'Cysteina',
                'Fenyloalanina + Tyrozyna',
                'Treonina',
                'Tryptofan',
                'Walina',
                'Histydyna'
            ];
            const data = {
                labels: labels,
                datasets: [
                    {
                      label: 'Zawartość aminokwasów w posiłku',
                      backgroundColor: function(context){
                         const chart = context.chart;
                         const {ctx, chartArea} = chart;
                         const name = "aminoacids";
                             if (!chartArea) {
                              return;
                            }
                            return getGradient(ctx, chartArea, name);
                      },
                      data: Object.values(mealAminoAcidContent),
                    }
                ]
            };

            const config = {
                type: 'bar',
                data: data,
                options: {
                    responsive:true,
                }
            };
            let chartName = 'chart' + meal.id;
            const myChart = new Chart(
                document.getElementById(chartName),
                config
            );

        }

        function getGradient(ctx, chartArea, name) {
              let width, height, gradient;
              const chartWidth = chartArea.right - chartArea.left;
              const chartHeight = chartArea.bottom - chartArea.top;
              if (!gradient || width !== chartWidth || height !== chartHeight) {
                width = chartWidth;
                height = chartHeight;
                gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                gradient = amountGraphGradient(gradient, name)
          }
          return gradient;
        }

        function amountGraphGradient(gradient, name) {
            if(name == 'requirements') {
                gradient.addColorStop(0, 'rgba(6, 1, 89, 1)');
                gradient.addColorStop(0.25, 'rgba(46, 46, 159, 1)');
                gradient.addColorStop(0.7, 'rgba(14, 192, 228, 1)');
            } else if (name == 'aminoacids') {
                gradient.addColorStop(0, 'rgba(66, 14, 7, 1)');
                gradient.addColorStop(0.25, 'rgba(170, 87, 12, 1)');
                gradient.addColorStop(0.7, 'rgba(238, 176, 90, 1)');
            }
            return gradient;
        }

        function getFoodData(foodName) {
            var detailData;
            ingredientsDetailData.forEach(food => {
                if(food.name == foodName) {
                    detailData = food;
                    console.log(food);
                    return;
                }
            })
            return detailData;
        }

    });

</script>
</body>
</html>