<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AminoAcidsApp</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
</head>
<body>
<div class="container custom-background">
    <a class="d-none" href="http://www.freepik.com">Background designed by starline / Freepik</a>

    <div class="row mx-4 py-3 bg-dark" th:replace="~{navbar.html :: navbar-copy}"></div>

    <main>
        <div class="container px-5">
            <div class="row my-3 text-center">
                <h3 class="text-bold"> Skomponuj swój posiłek dodając składniki do listy</h3>
            </div>
           <div class="row py-2">
               <div class="col-lg-5 col-sm-12 form-group">
                   <div class="row">
                       <div class="col-sm-6"><label for="ingredientPicker">Wybierz składnik z listy</label></div>
                       <div class="col-sm-6">
                           <select class="form-control" id="ingredientPicker"></select>
                       </div>
                   </div>
               </div>
               <div class="col-lg-4 col-sm-12 input-group mb-4">
                   <input type="number" id="massInput" class="form-control" placeholder="Wpisz masę składnika w g">
                   <div class="input-group-append">
                       <span class="input-group-text"> g</span>
                   </div>
               </div>
               <div class="col-lg-3 col-sm-12">
                   <button class="btn btn-success w-100" id="addToListBtn">Dodaj składnik do listy</button>
               </div>
           </div>
            <div class="row">
                <div class="col-sm-12" id="ingredientList">
                    <table class="table table-dark- table-small table-hover text-center">
                        <thead>
                            <tr>
                                <th scope="col">Lp.</th>
                                <th scope="col">Nazwa składnika</th>
                                <th scope="col">Masa składnika</th>
                                <th scope="col">Usuń składnik</th>
                            </tr>
                        </thead>
                        <tbody id="ingredientTableBody">

                        </tbody>
                    </table>
                </div>
            </div>
            <div class="row" sec:authorize="isAuthenticated()">
                <button class="btn btn-primary" id="saveMealButton">Zapisz posiłek w bazie</button>
            </div>
            <div class="row justify-content-center">
                <p class="text-center h2" id="responseText"></p>
            </div>
            <div class="row text-center my-1" id="summaryContainer">
                <div class="col-sm-12"><h4> Podsumowanie wartości odżywczych posiłku: </h4> </div>
                <div class="col-sm-12 text-center">

                </div>
            </div>
            <div class="row  align-items-center text-center my-2">
                <div class="col-md-8 col-sm-12">
                    <a role="button" data-toggle="popover" data-trigger="focus"
                       title="Zapotrzebowanie na poszczególne aminokwasy wg. WHO/FAO/UNU(2007) [mg/kg masy ciała]:"
                       data-content="Histydyna: 10, Izoleucyna: 20,
                                        Leucyna: 39, Metionina: 10, Cysteina: 4,
                                        Fenyloalanina + Tyrozyna: 25, Treonina: 15,
                                        Tryptofan: 4, Walina: 26, Lizyna: 30"
                       class="btn popover-dismiss color-black" tabindex="0">
                        <span><i class="bi bi-info-circle"></i></span>
                    </a>
                    <label for="bodyWeightInput" class="mx-1 mb-0">
                        Wpisz swoją masę do obliczeń zapotrzebowania:
                    </label>
                </div>
                <div class="col-md-4 col-sm-12 input-group">
                    <input type="number" id="bodyWeightInput" class="form-control" placeholder="Wpisz masę w kg">
                    <div class="input-group-append">
                        <span class="input-group-text"> kg</span>
                    </div>
                </div>
            </div>
            <div class="row d-none d-md-block">
                <div class="col-sm-12" id="chartContainer">
                </div>
            </div>
            <div class="row justify-content-center d-flex my-3 text-center">
                <table class="table table-dark table-striped" id="aminoAcidsTab"></table>
            </div>
        </div>
    </main>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
		jQuery(function () {
			jQuery('[data-toggle="popover"]').popover()
		});

		$('.popover-dismiss').popover({
		  trigger: 'focus'
		})
</script>
<script>
    $(document).ready(function() {
        var ingredientData;
        var requirements;
        const requirementResponse = fetch('/requirements').then( (response) => {
            return response.json();
        }).then( (json) => {
            requirements = json;
            attachButtonEvent();
            prepareList();
        });

        let ingredientShortList = new Array();

        async function prepareList() {
            if(sessionStorage.getItem("ingredientData") == null) {
                const response = await fetch('/commonIngredients/getAll').then( (response) => {
                    const contentType = response.headers.get('content-type');
                    if(response.ok && contentType.includes('application/json')){
                        return response.json();
                    }
                }).then( (json) => {
                    ingredientData = json;
                    sessionStorage.setItem("ingredientData", JSON.stringify(json));
                });
            } else {
                ingredientData = JSON.parse(sessionStorage.getItem("ingredientData"));
            }
            $('#ingredientPicker').html(createList(ingredientData));
            $('#bodyWeightInput').change(function() {
                prepareChart();
            });
            prepareChart()
        }

        function createList(json) {
            let htmlPrepared = "";
            json.forEach( option => {
                htmlPrepared += '<option value="' + option.id + '">' + option.name + '</option>';
            });
            return htmlPrepared;
        }

        function attachButtonEvent() {
            $('#addToListBtn').click(function() {
                appendToList();
            });
                $('#saveMealButton').click(function() {
                saveMealInDb();
            });
        }

        function appendToList() {
            var ingredientId = $("select option:selected").val();
            var name = $("select option:selected").text();
            var mass = $('#massInput').val();

            const regExp = /\D/;

            if(mass == "" || regExp.test(mass)){
                mass = 0;
            }

            let ingredientToList = {};
            ingredientToList.ingredientId = ingredientId;
            ingredientToList.name = name;
            ingredientToList.mass = mass;

            ingredientShortList.push(ingredientToList);
            prepareMealList();
        }

        function prepareMealList() {
            $('#ingredientTableBody').html('');
            ingredientShortList.forEach((element, index) => {
                let rowPrepared = '<tr scope="row"> <td>' + (index + 1) + '</td>';
                rowPrepared += '<td>' + element.name + '</td>';
                rowPrepared += '<td value="' + index + '">' + element.mass + 'g <i class="bi bi-pencil"></i></td>';
                rowPrepared += '<td value="' + index + '"> <i class="bi bi-x-circle-fill pointer"></i></td> </tr>';
                $('#ingredientTableBody').append(rowPrepared);
            });
            addDeleteEvent();
            addChangeMassEvent();
            prepareSummary();
            prepareChart();
        }

        function addDeleteEvent() {
            $('.bi.bi-x-circle-fill').click(function() {
                let index = $(this).parent().attr('value');
                ingredientShortList.splice(index, 1);
                $(this).parent().parent().remove();
                prepareMealList();
            });
        }

        function addChangeMassEvent() {
            $('.bi.bi-pencil').click(function() {
                let index = $(this).parent().attr('value');
                let massChange = prompt("Wprowadź zmienioną masę:");
                if(massChange != null && massChange != ""){
                    ingredientShortList[index].mass = massChange;
                }
                prepareMealList();
            });
        }

        function prepareSummary() {
            var protein = 0;
            var carbs = 0;
            var fat = 0;
            var energy = 0;
            ingredientShortList.forEach( element => {
                let ingredient = ingredientData[element.ingredientId -1];
                let fractionOfStandardMass = element.mass / 100;
                protein += ingredient.protein * fractionOfStandardMass;
                carbs += ingredient.carbs * fractionOfStandardMass;
                fat += ingredient.fat * fractionOfStandardMass;
                energy += ingredient.energy * fractionOfStandardMass;
            });
            var innerHtml = '<div class=\"col-sm-6\"> Zawartość kaloryczna: ' + energy.toFixed(0) + 'kcal</div>';
            innerHtml += '<div class=\"col-sm-6\"> Ilość białka: ' + protein.toFixed(1) + 'g</div>';
            innerHtml += '<div class=\"col-sm-6\"> Ilość węglowodanów: ' + carbs.toFixed(1) + 'g</div>';
            innerHtml += '<div class=\"col-sm-6\"> Ilość tłuszczu: ' + fat.toFixed(1) + 'g</div>';
            $('#summaryContainer').html(innerHtml);
        }

        function prepareChart() {
            $('canvas#chart').remove();
            $('#chartContainer').append('<canvas id="chart"></canvas>');
            let mass = $('#bodyWeightInput').val();
            const regExp = /\D/;

            if(mass == "" || regExp.test(mass)){
                mass = 70;
            }

            let requirementsChartLabel = "Zapotrzebowanie dla " + mass + " kg dorosłego";

            let requirementsCalculated = [
                requirements.isoleucine * mass,
                requirements.leucine * mass,
                requirements.lysine * mass,
                requirements.methionine * mass,
                requirements.cysteine * mass,
                requirements.phenylalanine_plus_tyrosine * mass,
                requirements.threonine * mass,
                requirements.tryptophan * mass,
                requirements.valine * mass,
                requirements.histidine * mass
            ];

            let mealAminoAcidContent = {
                isoleucine: 0,
                leucine: 0,
                lysine: 0,
                methionine: 0,
                cysteine: 0,
                phenylalaninePlusTyrosine: 0,
                threonine: 0,
                tryptophan: 0,
                valine: 0,
                histidine: 0
            };

            ingredientShortList.forEach(element => {
                let index = element.ingredientId - 1;
                let fractionOfStandardMass = element.mass / 100;
                let digestibility = ingredientData[index].digestibility;
                mealAminoAcidContent.isoleucine += Math.round(ingredientData[index].isoleucine *
                fractionOfStandardMass * digestibility);
                mealAminoAcidContent.leucine += Math.round(ingredientData[index].leucine * fractionOfStandardMass * digestibility);
                mealAminoAcidContent.lysine += Math.round(ingredientData[index].lysine * fractionOfStandardMass * digestibility);
                mealAminoAcidContent.methionine += Math.round(ingredientData[index].methionine * fractionOfStandardMass * digestibility);
                mealAminoAcidContent.cysteine += Math.round(ingredientData[index].cysteine * fractionOfStandardMass * digestibility);
                mealAminoAcidContent.phenylalaninePlusTyrosine += Math.round(ingredientData[index].phenylalanine *
                fractionOfStandardMass * digestibility);
                mealAminoAcidContent.phenylalaninePlusTyrosine += Math.round(ingredientData[index].tyrosine *
                fractionOfStandardMass * digestibility);
                mealAminoAcidContent.threonine += Math.round(ingredientData[index].threonine * fractionOfStandardMass * digestibility);
                mealAminoAcidContent.tryptophan += Math.round(ingredientData[index].tryptophan * fractionOfStandardMass * digestibility);
                mealAminoAcidContent.valine += Math.round(ingredientData[index].valine * fractionOfStandardMass * digestibility);
                mealAminoAcidContent.histidine += Math.round(ingredientData[index].histidine * fractionOfStandardMass * digestibility);
            });

             const labels = [
                'Izoleucyna',
                'Leucyna',
                'Lizyna',
                'Metionina',
                'Cysteina',
                'Fenyloalanina + Tyrozyna',
                'Treonina',
                'Tryptofan',
                'Walina',
                'Histydyna'
              ];

             prepareAminoAcidsTable(labels, requirementsCalculated, mealAminoAcidContent)

              const data = {
                labels: labels,
                datasets: [
                    {
                      label: 'Zawartość aminokwasów w posiłku',
                      backgroundColor: function(context){
                         const chart = context.chart;
                         const {ctx, chartArea} = chart;
                         const name = "aminoacids";
                             if (!chartArea) {
                              return;
                            }
                            return getGradient(ctx, chartArea, name);
                      },
                      data: Object.values(mealAminoAcidContent),
                    },
                    {
                        label: requirementsChartLabel,
                        data: requirementsCalculated,
                        backgroundColor: function(context){
                         const chart = context.chart;
                         const {ctx, chartArea} = chart;
                         const name = "requirements";
                             if (!chartArea) {
                              return;
                            }
                            return getGradient(ctx, chartArea, name);
                        },
                    }
                ]
              };

              const config = {
                type: 'bar',
                data: data,
                options: {
                    responsive:true,
                }
              };

               const myChart = new Chart(
                document.getElementById('chart'),
                config
              );
        }

        function getGradient(ctx, chartArea, name) {
              let width, height, gradient;
              const chartWidth = chartArea.right - chartArea.left;
              const chartHeight = chartArea.bottom - chartArea.top;
              if (!gradient || width !== chartWidth || height !== chartHeight) {
                width = chartWidth;
                height = chartHeight;
                gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                gradient = amountGraphGradient(gradient, name)
          }
          return gradient;
        }

        function amountGraphGradient(gradient, name) {
            if(name == 'requirements') {
                gradient.addColorStop(0, 'rgba(6, 1, 89, 1)');
                gradient.addColorStop(0.25, 'rgba(46, 46, 159, 1)');
                gradient.addColorStop(0.7, 'rgba(14, 192, 228, 1)');
            } else if (name == 'aminoacids') {
                gradient.addColorStop(0, 'rgba(66, 14, 7, 1)');
                gradient.addColorStop(0.25, 'rgba(170, 87, 12, 1)');
                gradient.addColorStop(0.7, 'rgba(238, 176, 90, 1)');
            }
            return gradient;
        }

        function prepareAminoAcidsTable(labels, requirements, aminoAcidAmountData) {
            let innerHtml = '<thead><tr>\
            <th scope=\"col\">Nazwa</th>\
            <th scope=\"col\">Ilość w posiłku [mg]</th>\
            <th scope=\"col\">Zapotrzebowanie</th>\
            </tr></thead><tbody>';

            let counter = 0;
            for (const [key, amount] of Object.entries(aminoAcidAmountData)){
                innerHtml += '<tr><td>' + labels[counter] + '</td>';
                innerHtml += '<td>' + amount + '</td>';
                innerHtml += '<td>' + requirements[counter] + '</td></tr>';
                counter++;
            }

            innerHtml += '</tbody>';
            $('#aminoAcidsTab').html(innerHtml);
        };

        function saveMealInDb() {
            let date = new Date();
            if(ingredientShortList.length == 0){
                $('#responseText').css('color', 'red');
                $('#responseText').html("Posiłek powinien zawierać przynajmniej jeden składnik.");
                return;
            }
            var caloricity = 0;
            ingredientShortList.forEach(el => {
                let ingredient = ingredientData[el.ingredientId -1];
                caloricity += parseInt(ingredient.energy * (el.mass / 100));
            });
            let meal = new Meal(date, ingredientShortList, caloricity);
            let mealJson = JSON.stringify(meal);
            $.post({
                    url: "/newMeal",
                    contentType: "application/json",
                    data: mealJson
               }).done(function(response) {
                    console.log(response);
                    if(response == "Data received") {
                        $('#responseText').css('color', 'green');
                        $('#responseText').html("Zapisano nowy posiłek w bazie! Możesz skomponować kolejny.");
                        let length = ingredientShortList.length;
                        ingredientShortList.splice(0, length);
                        $('#ingredientTableBody').html('');
                        $('#summaryContainer').html("");
                        $('#aminoAcidsTab').html("");
                        prepareChart();
                    }
               }).fail(function(response) {
                    alert("Błąd w zapisie posiłku w bazie");
                    console.log(response);
               });
        };

        function Meal (dateSaved, ingredients, caloricity) {
            this.dateSaved = dateSaved;
            this.ingredients = ingredients;
            this.caloricity = caloricity;
        }
    });



</script>
</body>
</html>