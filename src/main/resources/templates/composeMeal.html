<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AminoAcidsApp</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
</head>
<body>
<div class="container custom-background">
    <a class="d-none" href="http://www.freepik.com">Background designed by starline / Freepik</a>

    <div class="row mx-4 py-3 bg-dark" >
        <div class="col-sm-9 col-xs-12">
            <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
                <a class="navbar-brand home-icon" href="/"><i class="bi bi-house"></i></a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse align-items-center" id="navbar">
                    <ul class="navbar-nav px-3 w-100 text-center">
                        <li class="nav-item text-white menu-item font-weight-bold">
                            <a class="text-white" th:href="@{/composeMeal}">
                                <i class="bi bi-basket"></i>
                                <span class="ml-1">Skomponuj posiłek</span>
                            </a>
                        </li>
                        <li class="nav-item text-white menu-item font-weight-bold">
                            <a th:href="@{/commonIngredients}" class="text-white">
                                <i class="bi bi-list-columns"></i>
                                <span class="ml-1">Przegląd składników</span>
                            </a>
                        </li>
                        <li class="nav-item text-white menu-item font-weight-bold">
                            <a>
                                <i class="bi bi-folder2-open"></i>
                                <span class="ml-1">Zapisane posiłki</span>
                            </a>
                        </li>
                        <li class="nav-item text-white menu-item font-weight-bold">
                            <a>
                                <i class="bi bi-graph-up-arrow"></i>
                                <span class="ml-1">Dane statystyczne</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
        </div>
        <div class="col-sm-3 text-right d-none d-md-inline">
            <button class="btn btn-primary">Zaloguj się</button>
            <button class="btn btn-primary">Zarejestruj się</button>
        </div>
        <div class="col-xs-12 w-100 mx-2 d-block d-md-none">
            <button class="btn btn-primary w-100 mb-2">Zaloguj się</button>
            <button class="btn btn-primary w-100 ">Zarejestruj się</button>
        </div>
    </div>


    <main>
        <div class="container px-5">
            <div class="row my-3">
                <h3 class="text-bold"> Skomponuj swój posiłek dodając składniki do listy</h3>
            </div>
           <div class="row py-2">
               <div class="col-sm-6 form-group">
                   <div class="row">
                       <div class="col-sm-5"><label for="ingredientPicker">Wybierz składnik z listy</label></div>
                       <div class="col-sm-7"><select class="form-control" id="ingredientPicker">
                           <option>1</option>
                           <option>2</option>
                       </select></div>
                   </div>
               </div>
               <div class="col-sm-4 input-group mb-4">
                   <input type="number" id="massInput" class="form-control" placeholder="Wpisz masę składnika w g">
                   <div class="input-group-append">
                       <span class="input-group-text"> g</span>
                   </div>
               </div>
               <div class="col-sm-2">
                   <button class="btn btn-success" id="addToListBtn">Dodaj składnik do listy</button>
               </div>
           </div>
            <div class="row">
                <div class="col-sm-12" id="ingredientList">
                    <table class="table table-dark- table-small table-hover text-center">
                        <thead>
                            <tr>
                                <th>Lp.</th>
                                <th>Nazwa składnika</th>
                                <th>Masa składnika</th>
                                <th>Usuń składnik</th>
                            </tr>
                        </thead>
                        <tbody id="ingredientTableBody">

                        </tbody>
                    </table>
                </div>
            </div>
            <div class="row" id="summaryContainer">
                <div class="col-sm-12 text-center" >
                    summary placeholder
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <input type="number" text="Wprowadź swoją masę:">
                </div>
                <div class="col-sm-12" id="chartContainer">
                    chart placeholder
                </div>
            </div>
        </div>
    </main>
</div>

<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    $(document).ready(function() {
        let ingredientData;
        attachButtonEvent();
        prepareList();

        let ingredientShortList = new Array();

        function prepareList() {
            const response = fetch('/commonIngredients/getAll').then( (response) => {
                const contentType = response.headers.get('content-type');
                if(response.ok && contentType.includes('application/json')){
                    return response.json();
                }
            }).then( (json) => {
                ingredientData = json;
                $('#ingredientPicker').html(createList(json));
            });
        }

        function createList(json) {
            let htmlPrepared;
            json.forEach( option => {
                htmlPrepared += '<option value="' + option.id + '">' + option.name + '</option>';
            });
            return htmlPrepared;
        }

        function attachButtonEvent() {
            $('#addToListBtn').click(function() {
                appendToList();
            });
        }

        function appendToList() {
            var ingredientId = $("select option:selected").val();
            var name = $("select option:selected").text();
            var mass = $('#massInput').val();

            const regExp = /\D/;

            if(mass == "" || regExp.test(mass)){
                mass = 0;
            }

            let ingredientToList = {};
            ingredientToList.id = ingredientId;
            ingredientToList.name = name;
            ingredientToList.mass = mass;

            ingredientShortList.push(ingredientToList);
            prepareMealList();
        }

        function prepareMealList() {
            $('#ingredientTableBody').html('');
            ingredientShortList.forEach((element, index) => {
                let rowPrepared = '<tr> <td>' + (index + 1) + '</td>';
                rowPrepared += '<td>' + element.name + '</td>';
                rowPrepared += '<td>' + element.mass + '</td>';
                rowPrepared += '<td value="' + index + '"> <i class="bi bi-x-circle-fill pointer"></i>' + '</td> </tr>';
                $('#ingredientTableBody').append(rowPrepared);
            });
            addDeleteEvent();
            prepareSummary();
            prepareChart();
        }

        function addDeleteEvent() {
            $('.bi.bi-x-circle-fill').click(function() {
                let index = $(this).parent().attr('value');
                ingredientShortList.splice(index, 1);
                $(this).parent().parent().remove();
                prepareMealList();
            });
        }

        function prepareSummary() {
            var protein = 0;
            var carbs = 0;
            var fat = 0;
            var energy = 0;
            ingredientShortList.forEach( element => {
                let ingredient = ingredientData[element.id -1];
                let fractionOfStandardMass = element.mass / 100;
                protein += ingredient.protein * fractionOfStandardMass;
                carbs += ingredient.carbs * fractionOfStandardMass;
                fat += ingredient.fat * fractionOfStandardMass;
                energy += ingredient.energy * fractionOfStandardMass;
            });
            var innerHtml = '<div class=\"col-sm-6\"> Zawartość kaloryczna: ' + energy.toFixed(0) + 'kcal</div>';
            innerHtml += '<div class=\"col-sm-6\"> Ilość białka: ' + protein.toFixed(1) + 'g</div>';
            innerHtml += '<div class=\"col-sm-6\"> Ilość węglowodanów: ' + carbs.toFixed(1) + 'g</div>';
            innerHtml += '<div class=\"col-sm-6\"> Ilość tłuszczu: ' + fat.toFixed(1) + 'g</div>';
            $('#summaryContainer').html(innerHtml);
        }

        function prepareChart() {
            $('canvas#chart').remove();
            $('#chartContainer').append('<canvas id="chart"></canvas>');

            let mealAminoAcidContent = {
                isoleucine: 0,
                leucine: 0,
                lysine: 0,
                methionine: 0,
                cysteine: 0,
                phenylalaninePlusTyrosine: 0,
                threonine: 0,
                tryptophan: 0,
                valine: 0,
                histidine: 0
            };

            ingredientShortList.forEach(element => {
                let index = element.id - 1;
                let fractionOfStandardMass = element.mass / 100;
                mealAminoAcidContent.isoleucine += parseFloat(ingredientData[index].isoleucine *
                fractionOfStandardMass);
                mealAminoAcidContent.leucine += ingredientData[index].leucine * fractionOfStandardMass;
                mealAminoAcidContent.lysine += ingredientData[index].lysine * fractionOfStandardMass;
                mealAminoAcidContent.methionine += ingredientData[index].methionine * fractionOfStandardMass;
                mealAminoAcidContent.cysteine += ingredientData[index].cysteine * fractionOfStandardMass;
                mealAminoAcidContent.phenylalaninePlusTyrosine += ingredientData[index].phenylalanine *
                fractionOfStandardMass;
                mealAminoAcidContent.phenylalaninePlusTyrosine += ingredientData[index].tyrosine *
                fractionOfStandardMass;
                mealAminoAcidContent.threonine += ingredientData[index].threonine * fractionOfStandardMass;
                mealAminoAcidContent.tryptophan += ingredientData[index].tryptophan * fractionOfStandardMass;
                mealAminoAcidContent.valine += ingredientData[index].valine * fractionOfStandardMass;
                mealAminoAcidContent.histidine += ingredientData[index].histidine * fractionOfStandardMass;
            });

            console.log(mealAminoAcidContent);

             const labels = [
                'Izoleucyna',
                'Leucyna',
                'Lizyna',
                'Metionina',
                'Cysteina',
                'Fenyloalanina + Tyrozyna',
                'Treonina',
                'Tryptofan',
                'Walina',
                'Histydyna'
              ];

              const data = {
                labels: labels,
                datasets: [
                    {
                      label: 'Zawartość aminokwasów w posiłku',
                      backgroundColor: function(context){
                         const chart = context.chart;
                         const {ctx, chartArea} = chart;
                         const name = "aminoacids";
                             if (!chartArea) {
                              return;
                            }
                            return getGradient(ctx, chartArea, name);
                      },
                      data: Object.values(mealAminoAcidContent),
                    },
                ]
              };

              const config = {
                type: 'bar',
                data: data,
                options: {
                    responsive:true,
                }
              };

               const myChart = new Chart(
                document.getElementById('chart'),
                config
              );
        }

        function getGradient(ctx, chartArea, name) {
              let width, height, gradient;
              const chartWidth = chartArea.right - chartArea.left;
              const chartHeight = chartArea.bottom - chartArea.top;
              if (!gradient || width !== chartWidth || height !== chartHeight) {
                width = chartWidth;
                height = chartHeight;
                gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                gradient = amountGraphGradient(gradient, name)
          }
          return gradient;
        }

        function amountGraphGradient(gradient, name) {
            if(name == 'requirements') {
                gradient.addColorStop(0, 'rgba(6, 1, 89, 1)');
                gradient.addColorStop(0.25, 'rgba(46, 46, 159, 1)');
                gradient.addColorStop(0.7, 'rgba(14, 192, 228, 1)');
            } else if (name == 'aminoacids') {
                gradient.addColorStop(0, 'rgba(66, 14, 7, 1)');
                gradient.addColorStop(0.25, 'rgba(170, 87, 12, 1)');
                gradient.addColorStop(0.7, 'rgba(238, 176, 90, 1)');
            }
            return gradient;
        }
    });



</script>
</body>
</html>